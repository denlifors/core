generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  PARTNER
  CUSTOMER
}

enum BinarySide {
  LEFT
  RIGHT
}
enum PartnerStatus {
  PENDING
  ACTIVE
  INACTIVE
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  role     UserRole @default(CUSTOMER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner  Partner?
  customer Customer?
}

model Partner {
  id        String  @id @default(uuid())
  userId    String  @unique
  sponsorId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sponsor   Partner?  @relation("Sponsor", fields: [sponsorId], references: [id])
  downlines Partner[] @relation("Sponsor")

  customers      Customer[]
  binary         BinaryNode?
  wallets        Wallet[]
  volumeLedgers  VolumeLedger[]
  bonusLedgers   BonusLedger[]
  rankHistory    RankHistory[]
  cashbackWallet PartnerCashbackWallet?
  orders         Order[]
  weeklyStats    WeeklyBinaryStats[]
  monthlyStats   PartnerMonthlyStats[]
  annualBonuses  AnnualGlobalBonusPayout[]
  status        PartnerStatus @default(PENDING)
  activatedAt   DateTime?
  deactivatedAt DateTime?
  entryQualifiedAt DateTime?
  officeCity      String?
  officeOpenedAt  DateTime?

  @@index([sponsorId])
}

model Customer {
  id        String @id @default(uuid())
  userId    String @unique
  partnerId String
  referrerId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  partner   Partner   @relation(fields: [partnerId], references: [id])
  referrer  Customer? @relation("CustomerReferral", fields: [referrerId], references: [id])
  referrals Customer[] @relation("CustomerReferral")

  orders          Order[]
  cashbackWallet  CustomerCashbackWallet?

  @@index([partnerId])
  @@index([referrerId])
}

model BinaryNode {
  id        String     @id @default(uuid())
  partnerId String     @unique
  parentId  String?
  side      BinarySide

  leftVolume  Int @default(0)
  rightVolume Int @default(0)

  partner  Partner      @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  parent   BinaryNode?  @relation("BinaryTree", fields: [parentId], references: [id])
  children BinaryNode[] @relation("BinaryTree")

  @@index([parentId])
  @@index([side])
}

model Order {
  id             String  @id @default(uuid())
  customerId     String?
  buyerPartnerId String?

  totalPrice Int
  dv         Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer?   @relation(fields: [customerId], references: [id], onDelete: SetNull)
  buyerPartner Partner?    @relation(fields: [buyerPartnerId], references: [id], onDelete: SetNull)
  items        OrderItem[]

  @@index([customerId])
  @@index([buyerPartnerId])
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String

  product String
  price   Int
  dv      Int

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model VolumeLedger {
  id        String  @id @default(uuid())
  partnerId String
  orderId   String?
  dv        Int
  note      String?

  createdAt DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])

  @@index([partnerId])
  @@index([orderId])
}

model BonusLedger {
  id        String  @id @default(uuid())
  partnerId String
  type      String
  amount    Int
  note      String?

  createdAt DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])

  @@index([partnerId])
  @@index([type])
}

model Rank {
  id             String        @id @default(uuid())
  code           String        @unique
  name           String
  requiredVolume Int           @default(0)
  history        RankHistory[]
}

model RankHistory {
  id        String @id @default(uuid())
  partnerId String
  rankId    String

  createdAt DateTime @default(now())

  partner Partner @relation(fields: [partnerId], references: [id])
  rank    Rank    @relation(fields: [rankId], references: [id])

  @@index([partnerId])
  @@index([rankId])
}

model Wallet {
  id        String @id @default(uuid())
  partnerId String
  balance   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner      Partner             @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  transactions WalletTransaction[]

  @@index([partnerId])
}

model WalletTransaction {
  id       String  @id @default(uuid())
  walletId String
  amount   Int
  type     String
  note     String?

  createdAt DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
}

model PartnerCashbackWallet {
  id        String @id @default(uuid())
  partnerId String @unique
  balance   Int    @default(0) // в рублях, НЕ выводится

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner      Partner               @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  transactions CashbackTransaction[]
}

model CashbackTransaction {
  id       String  @id @default(uuid())
  walletId String
  amount   Int // + начисление, - списание
  type     String // CASHBACK_EARN / CASHBACK_SPEND
  note     String?

  createdAt DateTime @default(now())

  wallet PartnerCashbackWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
}

model WeeklyBinaryStats {
  id        String   @id @default(uuid())
  partnerId String
  weekStart DateTime // понедельник 00:00 UTC или локальный — закрепим позже

  leftDv  Int @default(0)
  rightDv Int @default(0)
  pairedDv     Int @default(0)
  leftCarryDv  Int @default(0)
  rightCarryDv Int @default(0)
  bonusAmount  Int @default(0)
  bonusPercent Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, weekStart])
  @@index([weekStart])
}

model PartnerMonthlyStats {
  id        String   @id @default(uuid())
  partnerId String
  monthStart DateTime

  personalDv     Int @default(0)
  personalAmount Int @default(0)
  leftDv         Int @default(0)
  rightDv        Int @default(0)
  structureDv    Int @default(0)
  isActive       Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  partner Partner @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@unique([partnerId, monthStart])
  @@index([monthStart])
}

model AnnualGlobalBonus {
  id          String @id @default(uuid())
  year        Int    @unique
  totalAmount Int

  createdAt DateTime @default(now())

  payouts AnnualGlobalBonusPayout[]
}

model AnnualGlobalBonusPayout {
  id            String @id @default(uuid())
  annualBonusId String
  partnerId     String
  amount        Int

  createdAt DateTime @default(now())

  annualBonus AnnualGlobalBonus @relation(fields: [annualBonusId], references: [id], onDelete: Cascade)
  partner     Partner           @relation(fields: [partnerId], references: [id], onDelete: Cascade)

  @@index([annualBonusId])
  @@index([partnerId])
}

model CustomerCashbackWallet {
  id         String @id @default(uuid())
  customerId String @unique
  balance    Int    @default(0) // в рублях, НЕ выводится

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  customer     Customer                     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions CustomerCashbackTransaction[]
}

model CustomerCashbackTransaction {
  id       String @id @default(uuid())
  walletId String
  amount   Int // + начисление, - списание
  type     String // CASHBACK_EARN / CASHBACK_SPEND
  note     String?

  createdAt DateTime @default(now())

  wallet CustomerCashbackWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([type])
}

model MarketingConfig {
  id                 String @id @default(uuid())
  dvToRubRate        Int    @default(30)
  partnerEntryDv     Int    @default(200)
  partnerActiveDv    Int    @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CashbackTier {
  id          String @id @default(uuid())
  minRub      Int
  maxRub      Int?
  percent     Int
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([minRub])
}

model InfluenceTier {
  id         String @id @default(uuid())
  level      Int
  percent    Int
  minSelfDv  Int
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([level])
  @@index([minSelfDv])
}

model BinaryBonusTier {
  id         String @id @default(uuid())
  minWeekDv  Int
  percent    Int
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([minWeekDv])
}

model RankRequirement {
  id             String @id @default(uuid())
  code           String @unique
  name           String
  minMinorLegDv  Int
  minSelfDv      Int
  depthLevels    Int
  isActive       Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GlobalBonusConfig {
  id        String @id @default(uuid())
  percent   Int
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RepresentativeBonusConfig {
  id                 String @id @default(uuid())
  percent            Int
  minRankCode        String
  requiresOffice     Boolean @default(true)
  isActive           Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CustomerCashbackConfig {
  id                  String @id @default(uuid())
  productPercent      Int
  referralPercent     Int
  maxSpendPercent     Int
  isActive            Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
